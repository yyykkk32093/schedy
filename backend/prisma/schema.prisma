generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---- OutboxEvent テーブル定義 ----

model OutboxEvent {
  id          String    @id
  aggregateId String
  eventName   String
  eventType   String
  routingKey  String
  payload     Json
  occurredAt  DateTime
  publishedAt DateTime?
  status      String    @default("PENDING")

  retryCount  Int      @default(0)
  nextRetryAt DateTime @default(now())

  @@index([status, nextRetryAt])
}

model OutboxRetryPolicy {
  routingKey   String @id // Handler に対応する routingKey
  maxRetries   Int    @default(5) // 最大リトライ回数
  baseInterval Int    @default(3000) // 初期インターバル（ms）
  maxInterval  Int    @default(60000) // インターバル上限（ms）

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id             String   @id
  idempotencyKey String   @unique //  = OutBoxイベントのid String  @id
  eventType      String
  userId         String
  authMethod     String
  detail         String?
  occurredAt     DateTime
  createdAt      DateTime @default(now())
}

model OutboxDeadLetter {
  id String @id @default(uuid())

  outboxEventId String
  routingKey    String
  eventType     String

  payload      Json
  errorMessage String?
  errorStack   String?

  occurredAt DateTime // 元イベントの発生時刻
  failedAt   DateTime @default(now())
}
